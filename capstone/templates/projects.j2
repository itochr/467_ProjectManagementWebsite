{% extends 'nav.j2' %}
{% block head %}
<title>Projects</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/projects.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}
{% block body %}

<div class="content">
    <h1><span class="username">{{accountUsername}}</span> Projects</h1>

    {% if screenMsg is defined %}
          <div class="announcement">{{ screenMsg }}</div>
    {% endif %}

    <!-- kanban board with drag & drop -->
    <div class="kanban-board">
        <div class="status-column" data-status="Planning" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h2>Planning</h2>
            <div class="column-content">
                {% for project in projects %}
                <div class="project-card"
                     draggable="true"
                     ondragstart="drag(event)"
                     onclick='showProjectDetails({{ project|tojson|safe }})'
                     id="project-{{ project.projectID }}">
                    <div class="project-content">
                        <h3>{{ project.projectName }}</h3>
                        <p>Due: {{ project.projectEnd }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="status-column" data-status="In Progress" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h2>In Progress</h2>
            <div class="column-content">
            </div>
        </div>

        <div class="status-column" data-status="Completed" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h2>Completed</h2>
            <div class="column-content">
            </div>
        </div>

        <!-- Keep your original Add New Project card -->
        <div class="project-card add-new-card" onclick="openCreateModal()">
            <div class="project-content">
                <div class="add-project-placeholder">
                    <h3>Create New Project</h3>
                    <span class="plus-symbol">+</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div id="createProjectModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('createProjectModal')">&times;</span>
        <h2>Create New Project</h2>
        <form action="{{ url_for('projects') }}" method="POST">
            <div class="form-group">
                <label for="projectName">Project Name:</label>
                <input type="text" name="projectName" required>
            </div>
            <div class="form-group">
                <label for="projectStatus">Status:</label>
                <select name="projectStatus" required>
                    <option value="Backlog">Backlog</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
            <div class="form-group">
                <label for="projectStart">Start Date:</label>
                <input type="date" name="projectStart" required>
            </div>
            <div class="form-group">
                <label for="projectEnd">End Date:</label>
                <input type="date" name="projectEnd" required>
            </div>
            <div class="form-actions">
                <button type="submit" name="createProject" class="submit-button">Create</button>
                <button type="button" class="cancel-button" onclick="closeModal('createProjectModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Project Details Modal -->
<div id="projectDetailsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('projectDetailsModal')">&times;</span>
        <h2>Project Details</h2>

        <!-- Edit -->
        <form action="{{ url_for('projects') }}" method="POST">
            <input type="hidden" id="projectID" name="projectID">
            <div class="form-group">
                <label for="projectName">Project Name:</label>
                <input type="text" id="editProjectName" name="projectName" required>
            </div>
            <div class="form-group">
                <label for="projectStart">Start Date:</label>
                <input type="date" id="editProjectStart" name="projectStart" required>
            </div>
            <div class="form-group">
                <label for="projectEnd">End Date:</label>
                <input type="date" id="editProjectEnd" name="projectEnd" required>
            </div>
            <div class="form-actions">
                <button type="submit" name="editProject" class="button submit-button">Save</button>
                <button type="button" class="button cancel-button" onclick="closeModal('projectDetailsModal')">Cancel</button>
                <button type="button" class="button delete-button" onclick="confirmDelete()">Delete</button>
            </div>
        </form>

        <form id="deleteForm" action="{{ url_for('projects') }}" method="POST" style="display: none;">
            <input type="hidden" id="deleteProjectID" name="projectID">
            <input type="hidden" name="deleteProject" value="true">
        </form>
    </div>
</div>

<script>
function openCreateModal() {
    document.getElementById('createProjectModal').style.display = 'block';
}

function showProjectDetails(project) {
    console.log('Project:', project);
    document.getElementById('projectID').value = project.projectID;
    document.getElementById('editProjectName').value = project.projectName;
    document.getElementById('editProjectStart').value = project.projectStart;
    document.getElementById('editProjectEnd').value = project.projectEnd;
    document.getElementById('projectDetailsModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this project?')) {
        const projectID = document.getElementById('projectID').value;
        document.getElementById('deleteProjectID').value = projectID;
        document.getElementById('deleteForm').submit();
    }
}

// drag and drop functions
function drag(event) {
    event.dataTransfer.setData("text", event.target.id);
}

function allowDrop(event) {
    event.preventDefault();
}

function drop(event) {
    event.preventDefault();
    const projectId = event.dataTransfer.getData("text");
    const projectCard = document.getElementById(projectId);

    // Find the column-content div to append to
    const column = event.target.closest('.status-column');
    if (column) {
        const columnContent = column.querySelector('.column-content');
        columnContent.appendChild(projectCard);
    }
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %}